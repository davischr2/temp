<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIST SP 800-53r5 Selection Tool</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        
        /* Selection Area Layout */
        .selectors { display: flex; gap: 20px; margin-bottom: 20px; }
        .box { flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #fff; }
        .box h3 { margin-top: 0; color: #2980b9; }
        
        /* Checkbox Lists */
        .checkbox-list { height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; }
        .checkbox-item { display: block; margin-bottom: 5px; }
        
        /* Buttons */
        .controls { margin-top: 15px; text-align: right; }
        button { padding: 10px 20px; background-color: #27ae60; color: white; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; }
        button:hover { background-color: #219150; }
        button#reset { background-color: #c0392b; margin-left: 10px; }

        /* Results Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #34495e; color: white; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* Loading State */
        #loading { color: #e67e22; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>NIST SP 800-53r5 Selection Worksheet</h1>
    <p>Select Authorities and Technologies to filter controls.</p>
    <div id="loading">Loading database...</div>

    <div class="selectors">
        <div class="box">
            <h3>Authorities</h3>
            <div id="auth-list" class="checkbox-list">Loading...</div>
        </div>

        <div class="box">
            <h3>Technologies</h3>
            <div id="tech-list" class="checkbox-list">Loading...</div>
        </div>
    </div>

    <div class="controls">
        <button id="find-btn">Find Controls</button>
        <button id="reset">Clear</button>
    </div>

    <h3>Selected Controls (<span id="count">0</span>)</h3>
    <div style="overflow-x:auto;">
        <table id="results-table">
            <thead>
                <tr id="table-headers"></tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="5">Select items and click Find to see results.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let mapData = [];
    let detailsData = [];
    let authColumns = [];
    let techColumns = [];

    // Helper: Parse CSV Text to Array of Objects
    function parseCSV(text) {
        const rows = text.trim().split('\n').map(row => row.split(',')); // Basic splitter
        const headers = rows[0].map(h => h.trim().replace(/"/g, '')); // Clean quotes
        const data = [];
        for (let i = 1; i < rows.length; i++) {
            let obj = {};
            let row = rows[i];
            // Handle simple cases; for robust CSV parsing involving commas in text, 
            // a library like PapaParse is recommended, but this works for "1"s and IDs.
            headers.forEach((h, index) => {
                obj[h] = row[index] ? row[index].trim() : "";
            });
            data.push(obj);
        }
        return { headers, data };
    }

    // 1. Load Data on Startup
    async function loadData() {
        try {
            // Fetch MAP sheet (Authorities)
            const mapRes = await fetch('map.csv');
            const mapText = await mapRes.text();
            const mapParsed = parseCSV(mapText);
            mapData = mapParsed.data;
            
            // Assume Col A is ID, rest are Authorities
            // Filter headers to exclude the first one (Control ID)
            authColumns = mapParsed.headers.slice(2); // Adjust index based on your sheet structure

            // Fetch DETAILS sheet (Technologies + Descriptions)
            const detRes = await fetch('details.csv');
            const detText = await detRes.text();
            const detParsed = parseCSV(detText);
            detailsData = detParsed.data;
            
            // Assume Col A is ID, next X columns are Tech, rest are Text
            // This logic mimics VBA: Techs are columns that have "1"s. 
            // For now, we list all headers from Details except the Control ID.
            techColumns = detParsed.headers.slice(1, 20); // Adjust slice to grab only Tech columns

            populateUI();
            document.getElementById('loading').style.display = 'none';

        } catch (err) {
            document.getElementById('loading').innerText = "Error loading CSV files. Ensure map.csv and details.csv are in the repo.";
            console.error(err);
        }
    }

    // 2. Populate Checkboxes
    function populateUI() {
        const authList = document.getElementById('auth-list');
        authList.innerHTML = authColumns.map(c => 
            `<label class="checkbox-item"><input type="checkbox" value="${c}" class="auth-chk"> ${c}</label>`
        ).join('');

        const techList = document.getElementById('tech-list');
        techList.innerHTML = techColumns.map(c => 
            `<label class="checkbox-item"><input type="checkbox" value="${c}" class="tech-chk"> ${c}</label>`
        ).join('');
    }

    // 3. The Core Logic (Replicating "GetTechnologies")
    function findControls() {
        const selectedAuths = Array.from(document.querySelectorAll('.auth-chk:checked')).map(c => c.value);
        const selectedTechs = Array.from(document.querySelectorAll('.tech-chk:checked')).map(c => c.value);
        
        let validControlIDs = new Set();

        // Pass 1: Check Authorities (Map Sheet)
        // VBA Logic: Loop Listbox -> Find columns -> If cell="1", add ID.
        mapData.forEach(row => {
            const controlID = Object.values(row)[0]; // First column is ID
            selectedAuths.forEach(auth => {
                if (row[auth] === "1") validControlIDs.add(controlID);
            });
        });

        // Pass 2: Check Technologies (Details Sheet)
        detailsData.forEach(row => {
            const controlID = Object.values(row)[0];
            selectedTechs.forEach(tech => {
                if (row[tech] === "1") validControlIDs.add(controlID);
            });
        });

        renderResults(Array.from(validControlIDs));
    }

    // 4. Render Results (Replicating "FindMatchingAssets")
    function renderResults(ids) {
        const tbody = document.getElementById('table-body');
        const thead = document.getElementById('table-headers');
        
        // Filter detailsData for the IDs we found
        const results = detailsData.filter(row => ids.includes(Object.values(row)[0]));
        
        document.getElementById('count').innerText = results.length;
        
        if (results.length === 0) {
            tbody.innerHTML = '<tr><td colspan="100%">No matching controls found.</td></tr>';
            return;
        }

        // Dynamic Headers based on Details Sheet
        const displayHeaders = Object.keys(results[0]); 
        thead.innerHTML = displayHeaders.map(h => `<th>${h}</th>`).join('');

        // Dynamic Rows
        tbody.innerHTML = results.map(row => {
            return `<tr>${Object.values(row).map(val => `<td>${val}</td>`).join('')}</tr>`;
        }).join('');
    }

    // Event Listeners
    document.getElementById('find-btn').addEventListener('click', findControls);
    document.getElementById('reset').addEventListener('click', () => {
        document.querySelectorAll('input').forEach(i => i.checked = false);
        document.getElementById('table-body').innerHTML = '';
        document.getElementById('count').innerText = '0';
    });

    // Start
    loadData();
</script>

</body>
</html>