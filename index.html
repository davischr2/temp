<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIST SP 800-53r5 Selection Tool</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 95%; margin: 0 auto; background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        
        .selectors { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .box { flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #fff; min-width: 300px; }
        .box h3 { margin-top: 0; color: #2980b9; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        
        .checkbox-list { height: 300px; overflow-y: auto; padding: 10px; background: #f9f9f9; border: 1px solid #eee;}
        .checkbox-item { display: block; margin-bottom: 4px; font-size: 13px; cursor: pointer; }
        .checkbox-item:hover { background-color: #eef; }
        .section-header { font-weight: bold; color: #666; margin-top: 10px; margin-bottom: 5px; background: #e0e0e0; padding: 2px 5px;}
        
        .controls { margin-top: 15px; text-align: right; margin-bottom: 20px;}
        button { padding: 10px 25px; background-color: #27ae60; color: white; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; font-weight: bold; }
        button:hover { background-color: #219150; }
        button#reset { background-color: #c0392b; margin-left: 10px; }

        .results-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
        
        table { width: 100%; border-collapse: collapse; margin-top: 0; font-size: 13px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; word-wrap: break-word;}
        th { background-color: #34495e; color: white; position: sticky; top: 0; z-index: 10;}
        tr:nth-child(even) { background-color: #f8f9fa; }
        tr:hover { background-color: #e8f4fc; }

        th:nth-child(1) { width: 80px; } /* Control ID */
        th:nth-child(2) { width: 200px; } /* Control Name */
        
        #loading { color: #e67e22; font-weight: bold; font-size: 18px;}
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>NIST SP 800-53r5 Selection Worksheet</h1>
    <div id="loading">Loading databases...</div>

    <div class="selectors">
        <div class="box">
            <h3>Authorities</h3>
            <div id="auth-list" class="checkbox-list"></div>
        </div>
        <div class="box">
            <h3>Control Classes / Technologies</h3>
            <div id="tech-list" class="checkbox-list"></div>
        </div>
    </div>

    <div class="controls">
        <button id="find-btn">Find Controls</button>
        <button id="reset">Clear Selection</button>
    </div>

    <div class="results-info">
        <h3>Selected Controls: <span id="count">0</span></h3>
    </div>

    <div style="overflow-x:auto; max-height: 600px; border: 1px solid #ccc;">
        <table id="results-table">
            <thead>
                <tr id="table-headers"><th>ID</th><th>Details</th></tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="2">Select items above and click 'Find Controls' to begin.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // --- Configuration based on VBA logic ---
    const CONFIG = {
        // Map.csv: Data starts at Row 4 (Index 3 in JS if including header). 
        // VBA logic: lstboxAuth Index i matches Col (i + 2) in Map.
        map: {
            dataStartRow: 2, // Skip headers
            colOffset: 2     // Index 0 in auth list = Index 2 (Col C) in Map CSV
        },
        // Details.csv: Data starts at Row 6 (Index 5).
        // VBA logic: lstboxTech Index i matches Col (i + 1) in Details.
        details: {
            dataStartRow: 1, 
            colOffset: 1,     // Index 0 in tech list = Index 1 (Col B) in Details CSV
            infoStartCol: 46 // Where the "1"s stop and the text (Name, Family) begins
        }
    };

    let appData = {
        mapData: [],
        detailsData: [],
        authoritiesList: [],
        technologiesList: [],
        infoCols: []
    };

    // --- CSV Parser ---
    function parseCSV(text) {
        const rows = [];
        let currentRow = [];
        let currentCell = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];

            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    currentCell += '"'; 
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                currentRow.push(currentCell.trim());
                currentCell = '';
            } else if ((char === '\r' || char === '\n') && !inQuotes) {
                if (currentCell || currentRow.length > 0) currentRow.push(currentCell.trim());
                if (currentRow.length > 0) rows.push(currentRow);
                currentRow = [];
                currentCell = '';
                if (char === '\r' && nextChar === '\n') i++; 
            } else {
                currentCell += char;
            }
        }
        if (currentCell || currentRow.length > 0) currentRow.push(currentCell.trim());
        if (currentRow.length > 0) rows.push(currentRow);
        return rows;
    }

    async function loadData() {
        try {
            // Fetch all 4 files
            const [authRes, classRes, mapRes, detRes] = await Promise.all([
                fetch('authorities.csv'),
                fetch('controlclasses.csv'),
                fetch('map.csv'),
                fetch('details.csv')
            ]);

            if (!authRes.ok || !classRes.ok || !mapRes.ok || !detRes.ok) 
                throw new Error("Failed to fetch one or more CSV files.");

            // Parse CSVs
            const authRaw = parseCSV(await authRes.text());
            const classRaw = parseCSV(await classRes.text());
            const mapRaw = parseCSV(await mapRes.text());
            const detRaw = parseCSV(await detRes.text());

            // 1. Setup Selection Lists (Skip header rows if they exist)
            // Assuming row 0 is a header based on CSV inspection
            appData.authoritiesList = authRaw.slice(1).map(r => r[0]); 
            appData.technologiesList = classRaw.slice(1).map(r => r[0]);

            // 2. Setup Data Arrays
            appData.mapData = mapRaw.slice(CONFIG.map.dataStartRow);
            appData.detailsData = detRaw.slice(CONFIG.details.dataStartRow);

            // 3. Define Info Columns (Control Name, Text, etc.)
            // We look at the header row of Details.csv (Row 0)
            const detailHeaders = detRaw[0];
            appData.infoCols = [];
            detailHeaders.forEach((col, index) => {
                if (!col) return;
                const upperCol = col.toUpperCase();
                if (["CONTROL NAME", "CONTROL FAMILY", "CONTROL TEXT", "CONTROL DISCUSSION"].includes(upperCol)) {
                    appData.infoCols.push({ name: col, index: index });
                }
            });

            populateUI();
            document.getElementById('loading').style.display = 'none';

        } catch (err) {
            document.getElementById('loading').innerHTML = `<span class="error">Error: ${err.message}. Ensure authorities.csv, controlclasses.csv, map.csv, and details.csv are in the repo.</span>`;
            console.error(err);
        }
    }

    function populateUI() {
        const createCheckboxes = (list, containerId, className) => {
            const container = document.getElementById(containerId);
            let html = '';
            
            list.forEach((name, index) => {
                if (!name) return;
                // Identify headers/separators by <<< >>> or all caps
                if (name.includes("<<<") || name === "SELECT ALL CONTROLS") {
                    html += `<div class="section-header">${name}</div>`;
                } else {
                    html += `<label class="checkbox-item">
                        <input type="checkbox" value="${index}" class="${className}"> ${name}
                    </label>`;
                }
            });
            container.innerHTML = html;
        };

        createCheckboxes(appData.authoritiesList, 'auth-list', 'auth-chk');
        createCheckboxes(appData.technologiesList, 'tech-list', 'tech-chk');
    }

    function findControls() {
        const selectedAuthIndices = Array.from(document.querySelectorAll('.auth-chk:checked')).map(cb => parseInt(cb.value));
        const selectedTechIndices = Array.from(document.querySelectorAll('.tech-chk:checked')).map(cb => parseInt(cb.value));

        let validIDs = new Set();

        // --- PASS 1: AUTHORITIES (Map.csv) ---
        // VBS: sRng = ColumnLetter(i + 2)
        // JS: Index i from auth list maps to mapData[row][i + 2]
        if (selectedAuthIndices.length > 0) {
            appData.mapData.forEach(row => {
                const id = row[0]; // Control ID (Col A)
                if (!id) return;

                // Check if row has "1" in any selected column
                // Note: Auth List Index 0 corresponds to Map Col 2. 
                // But we sliced the header off authList, so index 0 is actually the first item.
                // The headers in map.csv align with authorities.csv exactly.
                const match = selectedAuthIndices.some(idx => {
                    // CSV Column Index = Selected List Index + Offset
                    const csvColIndex = idx + CONFIG.map.colOffset;
                    return row[csvColIndex] == "1";
                });

                if (match) validIDs.add(id);
            });
        }

        // --- PASS 2: TECHNOLOGIES (Details.csv) ---
        // VBS: sRng = ColumnLetter(i + 1)
        // JS: Index i from tech list maps to detailsData[row][i + 1]
        if (selectedTechIndices.length > 0) {
            appData.detailsData.forEach(row => {
                const id = row[0];
                if (!id) return;

                const match = selectedTechIndices.some(idx => {
                    // CSV Column Index = Selected List Index + Offset
                    const csvColIndex = idx + CONFIG.details.colOffset;
                    return row[csvColIndex] == "1";
                });
                
                if (match) validIDs.add(id);
            });
        }

        // If nothing selected, clear results
        if (selectedAuthIndices.length === 0 && selectedTechIndices.length === 0) {
             validIDs.clear();
        }

        renderResults(validIDs);
    }

    function renderResults(validIDs) {
        const tbody = document.getElementById('table-body');
        const thead = document.getElementById('table-headers');
        const countSpan = document.getElementById('count');
        
        countSpan.innerText = validIDs.size;

        if (validIDs.size === 0) {
            tbody.innerHTML = '<tr><td colspan="100%">No controls match your selection.</td></tr>';
            return;
        }

        // Headers
        let headerHTML = '<th>ID</th>';
        appData.infoCols.forEach(col => {
            headerHTML += `<th>${col.name}</th>`;
        });
        thead.innerHTML = headerHTML;

        // Rows
        // We assume Control IDs in Details match Control IDs in Map
        const rowsHTML = appData.detailsData
            .filter(row => validIDs.has(row[0])) 
            .map(row => {
                let html = `<tr><td style="font-weight:bold; color:#2c3e50;">${row[0]}</td>`;
                appData.infoCols.forEach(col => {
                    html += `<td>${row[col.index] || ''}</td>`;
                });
                html += '</tr>';
                return html;
            })
            .join('');

        tbody.innerHTML = rowsHTML;
    }

    document.getElementById('find-btn').addEventListener('click', findControls);
    document.getElementById('reset').addEventListener('click', () => {
        document.querySelectorAll('input').forEach(i => i.checked = false);
        document.getElementById('table-body').innerHTML = '<tr><td colspan="100%">Selection cleared.</td></tr>';
        document.getElementById('count').innerText = '0';
    });

    // Initialize
    loadData();

</script>
</body>
</html>
