<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIST SP 800-53r5 Selection Tool</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 95%; margin: 0 auto; background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        
        .selectors { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .box { flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #fff; min-width: 300px; }
        .box h3 { margin-top: 0; color: #2980b9; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        
        .checkbox-list { height: 250px; overflow-y: auto; padding: 10px; background: #f9f9f9; border: 1px solid #eee;}
        .checkbox-item { display: block; margin-bottom: 4px; font-size: 14px; cursor: pointer; }
        .checkbox-item:hover { background-color: #eef; }
        
        .controls { margin-top: 15px; text-align: right; margin-bottom: 20px;}
        button { padding: 10px 25px; background-color: #27ae60; color: white; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; font-weight: bold; }
        button:hover { background-color: #219150; }
        button#reset { background-color: #c0392b; margin-left: 10px; }

        .results-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
        
        table { width: 100%; border-collapse: collapse; margin-top: 0; font-size: 13px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; word-wrap: break-word;}
        th { background-color: #34495e; color: white; position: sticky; top: 0; z-index: 10;}
        tr:nth-child(even) { background-color: #f8f9fa; }
        tr:hover { background-color: #e8f4fc; }

        /* Column widths */
        th:nth-child(1) { width: 80px; } /* Control ID */
        th:nth-child(2) { width: 200px; } /* Control Name */
        
        #loading { color: #e67e22; font-weight: bold; font-size: 18px;}
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>NIST SP 800-53r5 Selection Worksheet</h1>
    <div id="loading">Loading database...</div>

    <div class="selectors">
        <div class="box">
            <h3>Authorities</h3>
            <div id="auth-list" class="checkbox-list"></div>
        </div>
        <div class="box">
            <h3>Technologies</h3>
            <div id="tech-list" class="checkbox-list"></div>
        </div>
    </div>

    <div class="controls">
        <button id="find-btn">Find Controls</button>
        <button id="reset">Clear Selection</button>
    </div>

    <div class="results-info">
        <h3>Selected Controls: <span id="count">0</span></h3>
    </div>

    <div style="overflow-x:auto; max-height: 600px; border: 1px solid #ccc;">
        <table id="results-table">
            <thead>
                <tr id="table-headers"><th>ID</th><th>Details</th></tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="2">Select items above and click 'Find Controls' to begin.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // --- Configuration: Updated for new clean CSVs ---
    const CONFIG = {
        map: {
            headerRowIndex: 0,   // Row 1 (Header for Authorities)
            dataStartIndex: 2,   // Row 3 (Actual Data starts, skipping row 2 'CONTROL NAME' etc)
            authColStart: 2      // Column C (Index 2)
        },
        details: {
            techHeaderRowIndex: 0, // Row 1 (Header for Technologies)
            infoHeaderRowIndex: 0, // Row 1 (Same row has Control Name etc at the end)
            dataStartIndex: 1,     // Row 2 (Data starts immediately after header)
            techColStart: 1,       // Column B (Index 1)
        }
    };

    let appData = {
        mapData: [],
        detailsData: [],
        authMap: [],
        techMap: [],
        infoCols: []
    };

    // --- CSV Parser ---
    function parseCSV(text) {
        const rows = [];
        let currentRow = [];
        let currentCell = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];

            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    currentCell += '"'; 
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                currentRow.push(currentCell.trim());
                currentCell = '';
            } else if ((char === '\r' || char === '\n') && !inQuotes) {
                if (currentCell || currentRow.length > 0) currentRow.push(currentCell.trim());
                if (currentRow.length > 0) rows.push(currentRow);
                currentRow = [];
                currentCell = '';
                if (char === '\r' && nextChar === '\n') i++; 
            } else {
                currentCell += char;
            }
        }
        if (currentCell || currentRow.length > 0) currentRow.push(currentCell.trim());
        if (currentRow.length > 0) rows.push(currentRow);
        return rows;
    }

    async function loadData() {
        try {
            const [mapRes, detRes] = await Promise.all([
                fetch('map.csv'),
                fetch('details.csv')
            ]);

            if (!mapRes.ok || !detRes.ok) throw new Error("Failed to fetch CSV files");

            const mapRaw = parseCSV(await mapRes.text());
            const detRaw = parseCSV(await detRes.text());

            processMapData(mapRaw);
            processDetailsData(detRaw);

            populateUI();
            document.getElementById('loading').style.display = 'none';

        } catch (err) {
            document.getElementById('loading').innerHTML = `<span class="error">Error: ${err.message}. Ensure map.csv and details.csv are in the repository.</span>`;
            console.error(err);
        }
    }

    function processMapData(rows) {
        // 1. Extract Headers from Row 1
        const headerRow = rows[CONFIG.map.headerRowIndex];
        
        // 2. Map Authority Names
        for (let i = CONFIG.map.authColStart; i < headerRow.length; i++) {
            const name = headerRow[i];
            if (name && name.length > 1) { 
                appData.authMap.push({ name: name, index: i });
            }
        }
        // 3. Store Data Rows (Start from Row 3)
        appData.mapData = rows.slice(CONFIG.map.dataStartIndex);
    }

    function processDetailsData(rows) {
        // 1. Extract Tech Headers from Row 1
        const techHeaderRow = rows[CONFIG.details.techHeaderRowIndex];
        
        // 2. Map Tech Names
        // Scan until we hit "CONTROL NAME" or similar text columns
        for (let i = CONFIG.details.techColStart; i < techHeaderRow.length; i++) {
            const name = techHeaderRow[i];
            
            // Stop if we hit the info section
            if (name.toUpperCase().includes("CONTROL NAME") || name.toUpperCase() === "TOP LEVEL CONTROL") break; 
            
            // Add if it's a valid column
            if (name && name.length > 1 && name !== "--") {
                appData.techMap.push({ name: name, index: i });
            }
        }

        // 3. Identify Info Columns (Name, Text, Discussion)
        // These are also in Row 1, but further to the right
        appData.infoCols = [];
        techHeaderRow.forEach((col, index) => {
            if (!col) return;
            const upperCol = col.toUpperCase();
            // Pick the columns you want to show in the results table
            if (["CONTROL NAME", "CONTROL FAMILY", "CONTROL TEXT", "CONTROL DISCUSSION"].includes(upperCol)) {
                appData.infoCols.push({ name: col, index: index });
            }
        });

        // 4. Store Data Rows (Start from Row 2)
        appData.detailsData = rows.slice(CONFIG.details.dataStartIndex);
    }

    function populateUI() {
        const createCheckboxes = (list, containerId, className) => {
            const container = document.getElementById(containerId);
            container.innerHTML = list.map(item => 
                `<label class="checkbox-item"><input type="checkbox" value="${item.index}" class="${className}"> ${item.name}</label>`
            ).join('');
        };

        createCheckboxes(appData.authMap, 'auth-list', 'auth-chk');
        createCheckboxes(appData.techMap, 'tech-list', 'tech-chk');
    }

    function findControls() {
        const selectedAuthIndices = Array.from(document.querySelectorAll('.auth-chk:checked')).map(cb => parseInt(cb.value));
        const selectedTechIndices = Array.from(document.querySelectorAll('.tech-chk:checked')).map(cb => parseInt(cb.value));

        let validIDs = new Set();

        // Pass 1: Filter by Authorities (map.csv)
        if (selectedAuthIndices.length > 0) {
            appData.mapData.forEach(row => {
                const id = row[0]; // Control ID is always Col 0
                if (!id) return;
                
                // Check if ANY selected auth column has a "1"
                const match = selectedAuthIndices.some(index => row[index] === "1");
                if (match) validIDs.add(id);
            });
        }

        // Pass 2: Filter by Technologies (details.csv)
        if (selectedTechIndices.length > 0) {
            appData.detailsData.forEach(row => {
                const id = row[0];
                if (!id) return;

                const match = selectedTechIndices.some(index => row[index] === "1");
                if (match) validIDs.add(id);
            });
        }
        
        // If nothing selected, clear list
        if (selectedAuthIndices.length === 0 && selectedTechIndices.length === 0) {
             validIDs.clear();
        }

        renderResults(validIDs);
    }

    function renderResults(validIDs) {
        const tbody = document.getElementById('table-body');
        const thead = document.getElementById('table-headers');
        const countSpan = document.getElementById('count');
        
        countSpan.innerText = validIDs.size;

        if (validIDs.size === 0) {
            tbody.innerHTML = '<tr><td colspan="100%">No controls match your selection.</td></tr>';
            return;
        }

        // Build Table Headers
        let headerHTML = '<th>ID</th>';
        appData.infoCols.forEach(col => {
            headerHTML += `<th>${col.name}</th>`;
        });
        thead.innerHTML = headerHTML;

        // Build Rows
        // We match rows from detailsData based on the Control ID (Col 0)
        const rowsHTML = appData.detailsData
            .filter(row => validIDs.has(row[0])) 
            .map(row => {
                let html = `<tr><td style="font-weight:bold; color:#2c3e50;">${row[0]}</td>`;
                appData.infoCols.forEach(col => {
                    html += `<td>${row[col.index] || ''}</td>`;
                });
                html += '</tr>';
                return html;
            })
            .join('');

        tbody.innerHTML = rowsHTML;
    }

    document.getElementById('find-btn').addEventListener('click', findControls);
    document.getElementById('reset').addEventListener('click', () => {
        document.querySelectorAll('input').forEach(i => i.checked = false);
        document.getElementById('table-body').innerHTML = '<tr><td colspan="100%">Selection cleared.</td></tr>';
        document.getElementById('count').innerText = '0';
    });

    // Initialize
    loadData();

</script>
</body>
</html>
